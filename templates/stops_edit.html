{% extends "base.html" %}

{% block title %}编辑车站{% endblock %}
{% block pageLocation %}车站{% endblock %}
{% block pageName %}编辑车站{% endblock %}

{% block content %}
<div class="flex flex-wrap -mx-3">
  <div class="w-full max-w-full flex-none px-3 ">
    <div class="relative flex flex-col min-w-0 mb-6 break-words bg-white border-0 border-transparent border-solid shadow-xl rounded-2xl bg-clip-border">
      <div class="flex flex-row h-75-screen">
          <div class="max-w-full px-3 py-3 mb-6 md:mb-0 md:w-1/2 md:flex-none h-4/5">
              <div class="w-full h-full relative border border-solid shadow-none rounded-xl border-slate-100" id="container_map"></div>                  
          </div>
          <div class="max-w-full px-3 py-3 mb-6 md:mb-0 md:w-1/2 md:flex-none h-4/5">
            <div class=" px-3 py-3">
              <button type="button" name="getMarkerInfo" class="px-8 py-2 font-bold leading-normal text-center text-slate-700 align-middle transition-all ease-in border border-slate-700 rounded-lg shadow-md cursor-pointer text-xs bg-white lg:block tracking-tight-rem hover:bg-slate-700 hover:text-white hover:border-transparent active:opacity-85">获取坐标信息</button>            
            </div>
            <form action="{{ url_for('stops.edit', id=stop.id) }}" method="post">
              <div class="border border-solid border-slate-100 rounded-xl shadow-none px-3 py-3">
                  <div class="flex flex-wrap -mx-3">
                      <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                        <div class="mb-4">
                          <label for="name" class="inline-block mb-2 ml-1 font-bold text-sm text-slate-700 dark:text-white/80">名称</label>
                          <input type="text" name="name" placeholder="点击“获取坐标信息”获取，可手动修改" value="{{ stop.name }}" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                        </div>
                      </div>
                      <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                        <div class="mb-4">
                          <label for="label" class="inline-block mb-2 ml-1 font-bold text-sm text-slate-700 dark:text-white/80">标识符</label>
                          <input type="text" name="label" placeholder="非必填，系统自动生成" value="{{ stop.label }}" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                        </div>
                      </div>
                      <div class="w-full max-w-full px-3 shrink-0 md:w-full md:flex-0">
                        <div class="mb-4">
                          <label for="address" class="inline-block mb-2 ml-1 font-bold text-sm text-slate-700 dark:text-white/80">地址</label>
                          <input type="text" name="address" placeholder="点击“获取坐标信息”获取，可手动修改" value="{{ stop.address }}" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                        </div>
                      </div>
                      <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                        <div class="mb-4">
                          <label for="latitude" class="inline-block mb-2 ml-1 font-bold text-sm text-slate-700 dark:text-white/80">纬度</label>
                          <input type="text" name="latitude" placeholder="点击“获取坐标信息”获取，可手动修改" value="{{ stop.latitude }}" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                        </div>
                      </div>
                      <div class="w-full max-w-full px-3 shrink-0 md:w-6/12 md:flex-0">
                        <div class="mb-4">
                          <label for="longitude" class="inline-block mb-2 ml-1 font-bold text-sm text-slate-700 dark:text-white/80">经度</label>
                          <input type="text" name="longitude" placeholder="点击“获取坐标信息”获取，可手动修改" value="{{ stop.longitude }}" class="focus:shadow-primary-outline dark:bg-slate-850 dark:text-white text-sm leading-5.6 ease block w-full appearance-none rounded-lg border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-2 font-normal text-gray-700 outline-none transition-all placeholder:text-gray-500 focus:border-blue-500 focus:outline-none">
                        </div>
                      </div>
                  </div>
              </div>
          </div>
        <div>
      </div>
      </div>
      <div class="px-3 py-3 flex flex-row justify-end ">
        <a href="{{ url_for('stops.index') }}">
          <button type="button" name="cancel" class="px-8 py-2 font-bold leading-normal text-center text-slate-700 align-middle transition-all ease-in border border-slate-700 rounded-lg shadow-md cursor-pointer text-xs bg-white lg:hidden tracking-tight-rem hover:bg-slate-700 hover:text-white hover:border-transparent active:opacity-85">取消</button>
        </a>
        <button name="delete" class="px-8 py-2 font-bold leading-normal text-center text-red-500 align-middle transition-all ease-in border border-red-500 rounded-lg shadow-md cursor-pointer text-xs bg-white lg:block tracking-tight-rem hover:bg-red-500 hover:text-white hover:border-transparent active:opacity-85">删除</button>  
        <button type="submit" name="save" class="px-8 py-2 font-bold leading-normal text-center text-slate-700 align-middle transition-all ease-in border border-slate-700 rounded-lg shadow-md cursor-pointer text-xs bg-white lg:block tracking-tight-rem hover:bg-slate-700 hover:text-white hover:border-transparent active:opacity-85">保存</button>      
      </div>
    </form>
    </div>
  </div>
</div>

<!-- 地图的 JavaScript 代码 -->
<script type="text/javascript">
  window._AMapSecurityConfig = {
    securityJsCode: "{{ amap_js_key.scode }}", // flask 导入,下同
  };
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_js_key.key }}"></script>
<script type="text/javascript">
  // 创建地图实例
  var map = new AMap.Map("container_map", {
    zoom: 13,
    center: [{{ stop.longitude }}, {{ stop.latitude}}],
    resizeEnable: true
  });

  // 创建点标记
  var marker = new AMap.Marker({
    position: map.getCenter(), // 设置点标记位置为地图中心
    map: map
  });

  // 监听地图拖动事件
  map.on('dragging', function () {
    marker.setPosition(map.getCenter()); // 使点标记始终保持在地图中心
  });
  
  // 获取坐标信息按钮的点击事件
  document.querySelector('button[name="getMarkerInfo"]').addEventListener('click', function() {
    // 获取点标记的位置
    var position = marker.getPosition();

    // 使用高德地图的逆地理编码服务获取地址信息
    AMap.plugin('AMap.Geocoder', function() {
      var geocoder = new AMap.Geocoder({});
      geocoder.getAddress(position, function(status, result) {
        if (status === 'complete' && result.info === 'OK') {
          // 获取地址信息
            var address = result.regeocode.formattedAddress;
            var name = "";
            if (address.includes("街道")) {
            name = address.split("街道")[1];
            } else if (address.includes("镇")) {
            name = address.split("镇")[1];
            }

          // todo: 获取标识符 : 已经在flask中完成

          // 将地址、纬度和经度填充到各自的输入框中
          document.querySelector('input[name="address"]').value = address;
          document.querySelector('input[name="latitude"]').value = position.lat;
          document.querySelector('input[name="longitude"]').value = position.lng;
          document.querySelector('input[name="name"]').value = name;
          //document.querySelector('input[name="label"]').value = label;

          //var heading = calculateHeading(position, map.getCenter());
          //document.querySelector('input[name="label"]').value = heading;
        }
      });
    });
  });
</script>
{% endblock %}
